name: 🛠️ Matrix
on: 
  workflow_dispatch:
    inputs:
      profile:
        description: ENV Profile
        default: "DEFAULT"
        required: true

env:
  SCONSFLAGS: verbose=no warnings=no werror=no progress=no productions=yes
  SCONSFILES: profile=custom.py build_feature_profile=feature_profile.build
  SECRET_KEY: ${{ secrets[format('{0}_KEY', github.event.inputs.profile)] }}

jobs:
  windows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Godot
        uses: actions/checkout@v3
        with:
          repository: godotengine/godot
          ref: "4.0"

      - name: Setup Dependencies
        run: |
          rm -rf editor
          sudo apt-get -q install mingw-w64 > /dev/null
          echo "1" | sudo update-alternatives --config x86_64-w64-mingw32-g++ > /dev/null
          python -m pip install scons > /dev/null
          gcc -v
          ld -v
          python -c "import sys; print(sys.version)"
          scons --version

      - name: Setup build cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/.scons-cache/
          key: sconscache-windows
          restore-keys: sconscache-windows

      - name: Prepare Artifact
        run: ls -la

      - name: Building
        env:
          SCONS_CACHE: ${{ github.workspace }}/.scons-cache/
          SCONS_CACHE_LIMIT: 512
        run: scons platform=windows target=template_release arch=x86_64 use_mingw=yes lto=full ${{env.SCONSFILES}}

      - name: Prepare Artifact
        run: |
          ls -la bin
          strip bin/*.exe
          ls -la bin

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: templates
          path: bin/*
          retention-days: 3
